# source('./comparing_epsilons.R')
# source('./optimistic_initial_values.R')






setClass('bayesian_bandit', 
         slots = c(predicted_mean = 'numeric', true_mean = 'numeric', 
                   pull = 'numeric', lambda = 'numeric', sum_x = 'numeric', tau = 'numeric'), 
         prototype = prototype(predicted_mean = 0, true_mean = 0, lambda = 1, sum_x = 0, tau = 1))
pull <- function(object) 0; setGeneric("pull")
sample <- function(object) 0; setGeneric("sample")
#update <- function(object) 0; setGeneric('update')

setMethod("pull", signature(object = "bayesian_bandit"), function(object) {
  return(rnorm(1, 0, 1) + object@true_mean)
  
})

setMethod("update", signature(object = "bayesian_bandit"), function(object, x) {
  lambda = object@lambda + 1
  sum_x  <- object@sum_x + x
  predicted_mean = object@tau * sum_x / lambda
  
  return(list(lambda = lambda, sum_x = sum_x, predicted_mean = predicted_mean))
})

setMethod("sample", signature(object = "bayesian_bandit"), function(object) {
  to_ret <- rnorm(1)/sqrt(object@lambda) + object@predicted_mean
  return(to_ret)
})

bayesian_bandit <- function(true_mean){ new('bayesian_bandit',  true_mean = true_mean)}

# decaying epsilon ----------------------------------------------------------------------------


run_experiment_decaying_epsilon <- function(m1, m2, m3, eps, n) {
  bandits = list(bandit(m1), bandit(m2), bandit(m3))
  data = rep(NA, n)
  
  
  for (i in seq_len(n)){
    p = runif(1)
    if(p < 1/(i + 1)){
      j <- sample(1:3, 1, replace=F) 
    } else {
      j <- which.max(sapply(bandits, function(x) x@mean)) # to check
    }
    
    x <- pull(bandits[[j]])
    bandits[[j]]@n <- update(bandits[[j]], x)$n
    print(bandits[[j]]@n)
    bandits[[j]]@mean <- update(bandits[[j]], x)$mean
    data[i] <- x
  }
  
  lapply(bandits, function(x) print(x@mean))
  cum_avg <- cumsum(data) / ( seq_len(n))
  return(cum_avg)
}



# bayesian experiment -------------------------------------------------------------------------

run_experiment_bayes <- function(m1, m2, m3,  n) {
    
    bandits = list(bayesian_bandit(m1), bayesian_bandit(m2), bayesian_bandit(m3))
    data = rep(NA, n)
    
    
    for (i in seq_len(n)){
      # optimistic initial values
      j <- which.max(sapply(bandits, function(x) sample(x))) # to check
      x <- pull(bandits[[j]])
      
      bandits[[j]]@lambda <- update(bandits[[j]], x)$lambda
      bandits[[j]]@sum_x <- update(bandits[[j]], x)$sum_x
      bandits[[j]]@predicted_mean <- update(bandits[[j]], x)$predicted_mean
      data[i] <- x
      
    }
   
    
    
    #lapply(bandits, function(x) print(x@mean))
    cum_avg <- cumsum(data) / ( seq_len(n))
    return(cum_avg)
  }




m1 = 1
m2 = 2
m3 = 3
eps = run_experiment_eps(m1, m2, m3, 0.1, 1e04)
oiv = run_experiment_oiv(m1, m2, m3, 1e04)
bayes = run_experiment_bayes(m1, m2, m3, 1e04)


ggplot(data.frame(x=eps),               aes(x = seq_along(x), y = x, colour = 'eps')) + geom_line() +
  geom_line(data = data.frame(x=oiv),   aes(x = seq_along(x), y = x, colour = 'oiv')) +
  geom_line(data = data.frame(x=bayes), aes(x = seq_along(x), y = x, colour = 'bayes')) + 
  #geom_line(data = data.frame(x=c_01), aes(x = seq_along(x), y = x), colour = 'blue') + 
  scale_x_log10() + labs(y = 'sample_mean', x = 'n-th bandit choice')


