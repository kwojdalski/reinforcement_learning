BayesianBandit <- R6Class('BayesianBandit',
                          public = list(
                            initialize = function(true_mean){ 
                              self$true_mean = true_mean
                              invisible(self)
                            },
                            predicted_mean = 0,
                            true_mean      = 0,
                            lambda         = 1,
                            sum_x          = 0,
                            tau            = 1,
                            pull = function(){
                              return(rnorm(1) + self$true_mean)
                            },
                            update = function(x) {
                              self$lambda = self$lambda + 1
                              self$sum_x  = sum(self$sum_x, x)
                              self$predicted_mean = self$tau + self$sum_x / self$lambda
                            },
                            sample = function(){ rnorm(1)/sqrt(self$lambda) + self$predicted_mean}
                            
                          )
                          
)

# Decaying Epsilon
run_experiment_de <- function(m1, m2, m3, n) {
  bandits = list(Bandit$new(m1), Bandit$new(m2), Bandit$new(m3))
  data = rep(NA, n)
  
  
  for (i in seq_len(n)){
    p = runif(1)
    if(p < 1/(i + 1)){
      j <- base::sample(1:3, 1, replace=F) 
    } else {
      j <- which.max(sapply(bandits, function(x) x$mean)) # to check
    }
    
    x <- bandits[[j]]$pull()
    
    bandits[[j]]$update(x)
    data[i] <- x
  }
  
  lapply(bandits, function(x) print(x$mean))
  cum_avg <- cumsum(data) / ( seq_len(n))
  return(cum_avg)
}



run_experiment_bayes <- function(m1, m2, m3,  n) {
  
  bandits = list(BayesianBandit$new(m1), BayesianBandit$new(m2), BayesianBandit$new(m3))
  data = rep(NA, n)
  
  for (i in seq_len(n)){
    # optimistic initial values
    j <- which.max(sapply(bandits, function(x) x$sample())) # to check
    x <- bandits[[j]]$pull()
    bandits[[j]]$update(x)
    data[i] <- x
  }
  
  #lapply(bandits, function(x) print(x@mean))
  cum_avg <- cumsum(data) / ( seq_len(n))
  return(cum_avg)
}


m1 = 1
m2 = 2
m3 = 3
eps   = run_experiment_eps(m1, m2, m3, 0.1, 1e04)
oiv   = run_experiment_oiv(m1, m2, m3, 1e04)
de    = run_experiment_de(m1, m2, m3, 1e04)
bayes = run_experiment_bayes(m1, m2, m3, 1e04)
ucb_exp   = run_experiment_ucb(m1, m2, m3, 1e04)


data.frame(eps, oiv, de, bayes, ucb_exp) %>% reshape2::melt() %>% group_by(variable) %>% 
  mutate(index = row_number(variable)) %>% 
  ggplot(aes(x = index, y = value, colour = variable)) + 
  geom_line() + scale_x_log10() +
  labs(y = 'sample_mean', x = 'n-th bandit choice')


# ggplot(data.frame(x=eps),               aes(x = seq_along(x), y = x, colour = 'eps')) + geom_line() +
#   geom_line(data = data.frame(x=oiv),   aes(x = seq_along(x), y = x, colour = 'oiv')) +
#   geom_line(data = data.frame(x=bayes), aes(x = seq_along(x), y = x, colour = 'bayes')) + 
#   geom_line(data = data.frame(x=de),    aes(x = seq_along(x), y = x, colour = 'decaying_epsilon')) + 
#   geom_line(data = data.frame(x=ucb),   aes(x = seq_along(x), y = x, colour = 'ucb')) + 
#   scale_x_log10() + labs(y = 'sample_mean', x = 'n-th bandit choice')
